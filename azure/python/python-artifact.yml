

stages:
- stage: Testing
  jobs:
  - job: 'Test'
    pool:
      vmImage: 'ubuntu-16.04'
    strategy:
      matrix:
        Python36:
          python.version: '3.6'
        Python37:
          python.version: '3.7'
        Python38:
          python.version: '3.8'

    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(python.version)'

    - script: pip install flit
      displayName: 'Install flit build tool'

    - script: flit install
      displayName: 'Install library and its dependencies'

    - script: pytest
      displayName: 'Run Testing'

- stage: "Publish"
  condition: and(succeeded(),  ne(variables['release.version'], ''), eq(variables['Build.SourceBranch'], 'refs/heads/feature/azure-pipelines'))
  pool:
    vmImage: 'ubuntu-16.04'
  jobs:
    - job: "PublishPyPi"
      steps:

        - checkout: self
          persistCredentials: true

        - task: UsePythonVersion@0
          inputs:
            versionSpec: '3.7'

        - script: pip install pip --upgrade
          displayName: "Upgrade pip"

        - script: pip install bump2version
          displayName: 'Install bump2version'

        - script: pip install flit
          displayName: 'Install flit'

        - script: pip install twine
          displayName: 'Install twine'

        - script: |
            git config user.email "31185348+bakdata-bot@users.noreply.github.com"
            git config user.name "bakdata-bot"
            git fetch
            git checkout feature/azure-pipelines
          displayName: "Setting GitHub author"

        - script: bump2version $(release.version)
          displayName: "Bump version"

        - script: flit build
          displayName: "Build library"

        - script: git push --follow-tags origin feature/azure-pipelines
          displayName: "Pushing tag to github"

        - script: echo $(testpypi.username)
          displayName: "Testing username"

        - script: twine --verbose -u $(testpypi.username) -p $(testpypi.username) --repository-url https://test.pypi.org/legacy/ upload dist/*
          displayName: "Publish to PyPi"
